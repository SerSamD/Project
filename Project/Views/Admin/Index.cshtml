@model Project.ViewModels.AdminDashboardViewModel

@{
    ViewData["Title"] = "Tableau de Bord Administrateur";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-dark fw-bold">Tableau de Bord</h2>
    <span class="text-muted small">Dernière mise à jour : @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
</div>

<div class="row mb-5 g-4">

    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100 rounded-4 card-hover overflow-hidden">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 text-uppercase fw-bold small">En Attente</p>
                        <h2 class="fw-bold text-warning mb-0">@Model.UtilisateursEnAttente</h2>
                    </div>
                    <div class="icon-box bg-warning bg-opacity-10 text-warning rounded-circle">
                        <i class="fas fa-user-clock fa-2x"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <a asp-controller="Admin" asp-action="PendingUsers" class="text-decoration-none small fw-bold text-warning stretched-link">
                        Gérer les demandes <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100 rounded-4 card-hover overflow-hidden">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 text-uppercase fw-bold small">Enseignants</p>
                        <h2 class="fw-bold text-info mb-0">@Model.TotalEnseignants</h2>
                    </div>
                    <div class="icon-box bg-info bg-opacity-10 text-info rounded-circle">
                        <i class="fas fa-chalkboard-teacher fa-2x"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="small text-muted">Actifs sur la plateforme</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100 rounded-4 card-hover overflow-hidden">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 text-uppercase fw-bold small">Utilisateurs Actifs</p>
                        <h2 class="fw-bold text-success mb-0">
                            @(Model.TotalEtudiants + Model.TotalEnseignants + Model.TotalSurveillants)
                        </h2>
                    </div>
                    <div class="icon-box bg-success bg-opacity-10 text-success rounded-circle">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <a asp-controller="Admin" asp-action="ActiveUsers" class="text-decoration-none small fw-bold text-success stretched-link">
                        Voir la liste <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100 rounded-4 card-hover overflow-hidden">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 text-uppercase fw-bold small">Total (DB)</p>
                        <h2 class="fw-bold text-primary mb-0">@Model.TotalUtilisateurs</h2>
                    </div>
                    <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-circle">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="small text-muted">Inclus Admin & Rejetés</span>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="row">

    <div class="col-lg-8 mb-4">
        <div class="card shadow border-0 rounded-4 h-100">
            <div class="card-header py-3 bg-white d-flex flex-row align-items-center justify-content-between rounded-top-4">
                <h6 class="m-0 fw-bold text-primary">Moyenne des Groupes par Matière</h6>
            </div>
            <div class="card-body">
                <div class="chart-bar" style="height: 350px;">
                    <canvas id="moyenneBarChart"></canvas>
                </div>
                <hr>
                <small class="text-muted fst-italic">
                    <i class="fas fa-info-circle me-1"></i>
                    Ce graphique compare les moyennes générales (/20) obtenues par chaque groupe. Il se met à jour automatiquement dès que les notes sont publiées.
                </small>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-4">

        <div class="card shadow border-0 rounded-4 mb-4">
            <div class="card-header py-3 bg-white rounded-top-4">
                <h6 class="m-0 fw-bold text-primary">Répartition des Rôles</h6>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush small">
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                        <span><i class="fas fa-user-graduate me-2 text-muted"></i> Étudiants</span>
                        <span class="badge bg-primary rounded-pill">@Model.TotalEtudiants</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                        <span><i class="fas fa-chalkboard-teacher me-2 text-muted"></i> Enseignants</span>
                        <span class="badge bg-warning text-dark rounded-pill">@Model.TotalEnseignants</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                        <span><i class="fas fa-user-shield me-2 text-muted"></i> Surveillants</span>
                        <span class="badge bg-info text-white rounded-pill">@Model.TotalSurveillants</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="card shadow border-0 rounded-4">
            <div class="card-header py-3 bg-white rounded-top-4">
                <h6 class="m-0 fw-bold text-primary">Actions Rapides</h6>
            </div>
            <div class="card-body d-grid gap-3">
                <a asp-controller="Admin" asp-action="CreateUser" class="btn btn-primary rounded-pill fw-bold">
                    <i class="fas fa-plus-circle me-2"></i> Créer un compte
                </a>
                <a asp-controller="Admin" asp-action="PendingUsers" class="btn btn-warning rounded-pill fw-bold text-dark">
                    <i class="fas fa-check-circle me-2"></i> Voir les approbations
                </a>
                <a asp-controller="Admin" asp-action="ManageCourses" class="btn btn-light border rounded-pill fw-bold text-secondary">
                    <i class="fas fa-book me-2"></i> Gérer les cours
                </a>
            </div>
        </div>

    </div>
</div>

<style>
    /* Icône dans un cercle pastel */
    .icon-box {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
    }

    /* Animation au survol des cartes */
    .card-hover {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background: #fff;
    }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 1rem 3rem rgba(0,0,0,.1) !important;
        }

            .card-hover:hover .icon-box {
                transform: scale(1.1) rotate(5deg);
            }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Récupération du contexte
            var ctx = document.getElementById('moyenneBarChart').getContext('2d');

            // Récupération des données JSON envoyées par le Contrôleur via ViewBag
            // Si ViewBag est vide (ex: pas encore de données), on met des tableaux vides par sécurité
            var chartLabels = @Html.Raw(ViewBag.ChartLabels ?? "[]");
            var chartDatasets = @Html.Raw(ViewBag.ChartDatasets ?? "[]");

            var myBarChart = new Chart(ctx, {
                type: 'bar', // Barres verticales
                data: {
                    labels: chartLabels, // Axe X : Les Matières
                    datasets: chartDatasets // Les données : Groupes
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    layout: {
                        padding: { left: 10, right: 25, top: 25, bottom: 0 }
                    },
                    scales: {
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { maxTicksLimit: 6 }
                        },
                        y: {
                            min: 0,
                            max: 20, // Note maximale
                            ticks: {
                                padding: 10,
                                stepSize: 2
                            },
                            grid: {
                                color: "rgb(234, 236, 244)",
                                drawBorder: false,
                                borderDash: [2],
                                zeroLineBorderDash: [2]
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 8
                            }
                        },
                        tooltip: {
                            backgroundColor: "rgb(255,255,255)",
                            bodyColor: "#858796",
                            titleColor: '#6e707e',
                            titleFont: { size: 14 },
                            borderColor: '#dddfeb',
                            borderWidth: 1,
                            xPadding: 15,
                            yPadding: 15,
                            displayColors: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '/20';
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>
}