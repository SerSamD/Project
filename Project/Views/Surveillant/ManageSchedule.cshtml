@using Project.Models
@using Project.ViewModels
@using System.Globalization

@model AddScheduleViewModel

@{
    ViewData["Title"] = "Gérer l'Emploi du Temps";

    var days = Enum.GetValues(typeof(DayOfWeek)).Cast<DayOfWeek>()
        .Where(d => d != DayOfWeek.Saturday && d != DayOfWeek.Sunday)
        .OrderBy(d => (int)d == 0 ? 7 : (int)d)
        .ToList();

    var startHour = 8;
    var endHour = 18;

    if (Model.ScheduleList != null && Model.ScheduleList.Any())
    {
        int minDataHour = Model.ScheduleList.Min(s => s.HeureDebut.Hours);
        int maxDataHour = Model.ScheduleList.Max(s => s.HeureFin.Hours);
        if (Model.ScheduleList.Any(s => s.HeureFin.Minutes > 0)) maxDataHour++;
        if (minDataHour < startHour) startHour = minDataHour;
        if (maxDataHour > endHour) endHour = maxDataHour;
    }
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<h1>Gérer l'Emploi du Temps</h1>

@if (ViewBag.SuccessMessage != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @ViewBag.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        @ViewBag.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white">Sélectionner un Groupe</div>
    <div class="card-body">
        <form asp-action="ManageSchedule" method="get">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Choisir le Groupe :</label>
                    <select name="groupId" class="form-select" onchange="this.form.submit()">
                        <option value="">-- Sélectionnez un Groupe --</option>
                        @foreach (var item in Model.Groupes)
                        {
                            <option value="@item.Value" selected="@(item.Value == Model.GroupeId.ToString())">
                                @item.Text
                            </option>
                        }
                    </select>
                </div>
            </div>
        </form>
    </div>
</div>

@if (Model.GroupeId > 0)
{
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
        <h2>
            Planning pour :
            <span class="badge bg-primary">@Model.SelectedGroupName</span>
        </h2>

        <form asp-action="ResetSchedule" method="post">
            <input type="hidden" name="groupId" value="@Model.GroupeId" />
            <button type="submit" class="btn btn-danger"
                    onclick="return confirm('ATTENTION : Vous allez supprimer TOUTES les sessions.\nAction irréversible.');">
                <i class="fas fa-trash-alt me-2"></i> Réinitialiser
            </button>
        </form>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">Ajouter une Session</div>
        <div class="card-body">
            <form asp-action="AddSession" method="post">
                <input type="hidden" asp-for="GroupeId" />

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label asp-for="CoursId">Matière</label>
                        <select asp-for="CoursId" class="form-select" asp-items="Model.CoursList"></select>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label asp-for="EnseignantId">Enseignant</label>
                        <select asp-for="EnseignantId" class="form-select" asp-items="Model.Enseignants"></select>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label asp-for="Jour">Jour</label>
                        <select asp-for="Jour" class="form-select" asp-items="Model.Jours"></select>
                    </div>

                    <div class="col-md-3 mb-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">Ajouter</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label asp-for="HeureDebut">Début</label>
                        <input asp-for="HeureDebut" class="form-control timepicker" required />
                    </div>

                    <div class="col-md-3 mb-3">
                        <label asp-for="HeureFin">Fin</label>
                        <input asp-for="HeureFin" class="form-control timepicker" required />
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Heure</th>
                    @foreach (var day in days)
                    {
                        <th>@day</th>
                    }
                </tr>
            </thead>
            <tbody>
                @for (int hour = startHour; hour < endHour; hour++)
                {
                    <tr>
                        <th class="bg-light">@hour:00 - @(hour + 1):00</th>
                        @foreach (var day in days)
                        {
                            <td class="align-top p-1" style="min-width:160px; height:80px;">
                                @{
                                    var sessions = Model.ScheduleList
                                    .Where(s => s.Jour == day &&
                                    s.HeureDebut.Hours <= hour &&
                                    s.HeureFin.Hours > hour)
                                    .ToList();
                                }

                                @foreach (var session in sessions)
                                {
                                    <div class="card bg-info text-dark mb-1 p-1 position-relative border-0 shadow-sm text-start">

                                        <!-- BOUTON SUPPRIMER -->
                                        <div class="position-absolute top-0 end-0 p-1">
                                            <form asp-action="DeleteSession" method="post">
                                                <input type="hidden" name="sessionId" value="@session.Id" />
                                                <button type="submit"
                                                        class="btn btn-link text-danger p-0"
                                                        onclick="return confirm('Supprimer cette session ?');">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </form>
                                        </div>

                                        <div class="pe-4">
                                            <strong class="d-block">@session.Cours?.Titre</strong>

                                            @if (session.Enseignant?.Utilisateur != null)
                                            {
                                                <small class="text-muted d-block">
                                                    @session.Enseignant.Utilisateur.Nom
                                                </small>
                                            }

                                            <span class="badge bg-light text-dark mt-1">
                                                @session.HeureDebut.ToString(@"hh\:mm")
                                                -
                                                @session.HeureFin.ToString(@"hh\:mm")
                                            </span>
                                        </div>
                                    </div>
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        Veuillez sélectionner un groupe.
    </div>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            flatpickr(".timepicker", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                minTime: "08:00",
                maxTime: "18:00"
            });
        });
    </script>
}
