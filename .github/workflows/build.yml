name: ðŸ”¨ Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        dotnet-version: [ '9.0.x' ]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
        
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore Project/Project.csproj
      
    - name: ðŸ”¨ Build
      run: dotnet build Project/Project.csproj --configuration Release --no-restore
      
    - name: âœ… Test (if tests exist)
      run: |
        if [ -d "Project.Tests" ]; then
          dotnet test --configuration Release --no-build --verbosity normal
        else
          echo "âš ï¸ No tests found - skipping test execution"
        fi
      
    - name: ðŸ“Š Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: build-artifacts
        path: |
          Project/bin/Release/
          !Project/bin/Release/**/ref/
        retention-days: 7

  code-quality:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: ðŸ§¹ Format check
      run: dotnet format Project/Project.csproj --verify-no-changes --verbosity diagnostic || echo "âš ï¸ Code formatting issues detected. Run 'dotnet format' locally."
      continue-on-error: true

  security:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Run security scan
      uses: github/codeql-action/init@v3
      with:
        languages: csharp
        
    - name: ðŸ”¨ Autobuild
      uses: github/codeql-action/autobuild@v3
      
    - name: ðŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  dependency-check:
    name: ðŸ“¦ Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Check for known vulnerabilities
      run: |
        echo "ðŸ” Checking NuGet packages for known vulnerabilities..."
        dotnet list Project/Project.csproj package --vulnerable --include-transitive || echo "âœ… No known vulnerabilities found"
      continue-on-error: true

  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [build, code-quality, security, dependency-check]
    if: always()
    
    steps:
    - name: ðŸ“Š Job Summary
      run: |
        echo "### ðŸŽ‰ Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Success' || 'âš ï¸ Warning' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security | ${{ needs.security.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependencies | ${{ needs.dependency-check.result == 'success' && 'âœ… Success' || 'âš ï¸ Warning' }} |" >> $GITHUB_STEP_SUMMARY
